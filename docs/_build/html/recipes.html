
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tailoring View Recipes &mdash; djangotailoring v0.5 documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="djangotailoring v0.5 documentation" href="index.html" />
    <link rel="prev" title="djangotailoring.tracking.views" href="apps/djangotailoring.tracking/views.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="apps/djangotailoring.tracking/views.html" title="djangotailoring.tracking.views"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">djangotailoring v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tailoring-view-recipes">
<h1>Tailoring View Recipes<a class="headerlink" href="#tailoring-view-recipes" title="Permalink to this headline">¶</a></h1>
<p>In here, you will find a set of sample code that can be used to both steal for
actual use, as well as learn about possible ways of building the types of
functionality you need for your app.</p>
<p>In each recipe, if a template is provided, it is assumed that there is a
template called <tt class="docutils literal"><span class="pre">base.html</span></tt> that includes a block called <tt class="docutils literal"><span class="pre">content</span></tt>.</p>
<div class="section" id="tailoring-views">
<h2>Tailoring Views<a class="headerlink" href="#tailoring-views" title="Permalink to this headline">¶</a></h2>
<p>In this section, views pertaining to producing MTS Message documents are
outlined.</p>
<div class="section" id="a-basic-tailored-page">
<span id="basic-tailored-page"></span><h3>A Basic Tailored Page<a class="headerlink" href="#a-basic-tailored-page" title="Permalink to this headline">¶</a></h3>
<p>Consider a situation where there is a Message document called
<tt class="docutils literal"><span class="pre">Messages/MyTailoredDoc.messages</span></tt> in your MTS project folder, and it has
sections called &#8216;Intro&#8217;, &#8216;Part1&#8217;, and &#8216;Part2&#8217;.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">TailoredDocView</span>

<span class="k">class</span> <span class="nc">MyTailoredDocView</span><span class="p">(</span><span class="n">TailoredDocView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/mypage.html&#39;</span>
    <span class="n">message_document</span> <span class="o">=</span> <span class="s">&#39;Messages/MyTailoredDoc.messages&#39;</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">templates/myapp/mypage.html</span></tt>:</p>
<div class="highlight-python"><pre>{% extends "base.html" %}

{% load tailoring2tags %}

{% block content %}
  {% render_section treq "Intro" %}
  {% render_section treq "Part1" %}
  {% render_section treq "Part2" %}
{% endblock %}</pre>
</div>
</div>
<div class="section" id="an-enhanced-tailored-page">
<span id="enhanced-tailored-page"></span><h3>An Enhanced Tailored Page<a class="headerlink" href="#an-enhanced-tailored-page" title="Permalink to this headline">¶</a></h3>
<p>Using the same message doc from above in
<a class="reference internal" href="#basic-tailored-page"><em>Basic Tailored Page</em></a>, you could also choose to
have the section choices be made by a parameter to the view.</p>
<p>In <tt class="docutils literal"><span class="pre">myapps/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">TailoredDocView</span>

<span class="k">class</span> <span class="nc">MyEnhancedDocView</span><span class="p">(</span><span class="n">TailoredDocView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/myenhancedpage.html&#39;</span>
    <span class="n">message_document</span> <span class="o">=</span> <span class="s">&#39;Messages/MyTailoredDoc.messages&#39;</span>

    <span class="k">def</span> <span class="nf">get_selected_section</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method checks the keyword arguments to my view to find</span>
<span class="sd">        a section name.&quot;&quot;&quot;</span>
        <span class="n">section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;section_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Part1&#39;</span><span class="p">,</span> <span class="s">&#39;Part2&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Http404</span>
        <span class="k">return</span> <span class="n">section_name</span>

    <span class="c"># overrides a view method</span>
    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;section_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_section</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyEnhancedDocView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">templates/myapp/myenhancedpage.html</span></tt>:</p>
<div class="highlight-python"><pre>{% extends "base.html" %}

{% load tailoring2tags %}

{% block content %}
  {% render_section treq "Intro" %}
  {% render_section treq section_name %}
{% endblock %}</pre>
</div>
<p>In <tt class="docutils literal"><span class="pre">urls.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">myapps.views</span> <span class="kn">import</span> <span class="n">MyEnhancedDocView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">r&#39;^enhanced1/$&#39;</span><span class="p">,</span> <span class="n">MyEnhancedDocView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="p">{</span>
      <span class="s">&#39;section_name&#39;</span><span class="p">:</span> <span class="s">&#39;Part1&#39;</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s">r&#39;^enhanced2/$&#39;</span><span class="p">,</span> <span class="n">MyEnhancedDocView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="p">{</span>
      <span class="s">&#39;section_name&#39;</span><span class="p">:</span> <span class="s">&#39;Part2&#39;</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s">r&#39;^enhanced3/$&#39;</span><span class="p">,</span> <span class="n">MyEnhancedDocView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="p">(</span><span class="s">r&#39;^enhanced4/(?P&lt;section_name&gt;.*)/$&#39;</span><span class="p">,</span> <span class="n">MyEnhancedDocView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here, the following will happen at each URL:</p>
<ul class="simple">
<li>/enhanced1/:
Intro and Part1 appear in the tailored output.</li>
<li>/enhanced2/:
Intro and Part2 appear in the tailored output.</li>
<li>/enhanced3/:
404 Not Found</li>
<li>/enhanced4/Part1/:
Intro and Part1 appear in the tailored output.</li>
<li>/enhanced4/Part3/:
404 Not Found</li>
</ul>
</div>
<div class="section" id="multiple-documents-on-a-page">
<span id="id1"></span><h3>Multiple Documents on a Page<a class="headerlink" href="#multiple-documents-on-a-page" title="Permalink to this headline">¶</a></h3>
<p>Consider we have a second document in addition to the one from
<a class="reference internal" href="#basic-tailored-page"><em>the first example</em></a>. This document is called
<tt class="docutils literal"><span class="pre">Messages/Graphic.messages</span></tt>, which contains a single section named &#8216;Header&#8217;.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">MultipleTailoredDocView</span>

<span class="k">class</span> <span class="nc">MyMultipleDocView</span><span class="p">(</span><span class="n">MultipleTailoredDocView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/multidoc.html&#39;</span>
    <span class="n">message_documents</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;graphic&#39;</span><span class="p">:</span> <span class="s">&#39;Messages/Graphic.messages&#39;</span><span class="p">,</span>
        <span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;Messages/MyTailoredDoc.messages&#39;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">myapp/multidoc.html</span></tt>:</p>
<div class="highlight-python"><pre>{% extends "base.html" %}

{% load tailoring2tags %}

{% block content %}
  {% render_section graphics "Header" %}
  {% render_section doc "Intro" %}
  {% render_section doc "Part1" %}
  {% render_section doc "Part2" %}
{% endblock %}</pre>
</div>
</div>
<div class="section" id="tailored-page-titles">
<span id="id2"></span><h3>Tailored Page Titles<a class="headerlink" href="#tailored-page-titles" title="Permalink to this headline">¶</a></h3>
<p>Consider a message doc named <tt class="docutils literal"><span class="pre">Messages/MyPage.messages</span></tt> which has a section
named &#8216;Title&#8217; as well as &#8216;Main&#8217;. &#8216;Title&#8217; is destined for the HTML page&#8217;s
title, so let’s go there.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/urls.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">TailoredDocView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s">r&#39;^mypage/$&#39;</span><span class="p">,</span>
      <span class="n">TailoredDocView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">template_name</span><span class="o">=</span><span class="s">&#39;myapp/simple.html&#39;</span><span class="p">,</span>
        <span class="n">message_document</span><span class="o">=</span><span class="s">&#39;Messages/MyPage.messages&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">templates/myapp/simple.html</span></tt>:</p>
<div class="highlight-python"><pre>{% load tailoring2tags %}
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;{% render_section treq "Title" nowrap %}&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    {% render_section treq "Main" %}
  &lt;/body&gt;
&lt;/html&gt;</pre>
</div>
</div>
<div class="section" id="logging-page-views">
<span id="id3"></span><h3>Logging Page Views<a class="headerlink" href="#logging-page-views" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s log the hits to the view from
<a class="reference internal" href="#basic-tailored-page"><em>the first example</em></a>.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">TailoredDocView</span>
<span class="kn">from</span> <span class="nn">djangotailoring.tracking.views</span> <span class="kn">import</span> <span class="n">LogPageViewMixin</span>

<span class="k">class</span> <span class="nc">MyTailoredDocView</span><span class="p">(</span><span class="n">LogPageViewMixin</span><span class="p">,</span> <span class="n">TailoredDocView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/mypage.html&#39;</span>
    <span class="n">message_document</span> <span class="o">=</span> <span class="s">&#39;Messages/MyTailoredDoc.messages&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="protecting-page-access">
<span id="id4"></span><h3>Protecting Page Access<a class="headerlink" href="#protecting-page-access" title="Permalink to this headline">¶</a></h3>
<p>To protect a view like the one used in
<a class="reference internal" href="#basic-tailored-page"><em>the first example</em></a>, mix in a
<a class="reference internal" href="apps/djangotailoring/views/protection.html#djangotailoring.views.protection.LoginRequiredMixin" title="djangotailoring.views.protection.LoginRequiredMixin"><tt class="xref py py-class docutils literal"><span class="pre">LoginRequiredMixin</span></tt></a>.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">TailoredDocView</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span>

<span class="k">class</span> <span class="nc">MyTailoredDocView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">TailoredDocView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/mypage.html&#39;</span>
    <span class="n">message_document</span> <span class="o">=</span> <span class="s">&#39;Messages/MyTailoredDoc.messages&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="logging-protected-page-access">
<span id="id5"></span><h3>Logging Protected Page Access<a class="headerlink" href="#logging-protected-page-access" title="Permalink to this headline">¶</a></h3>
<p>Let’s combine the previous <a class="reference internal" href="#logging-page-views"><em>two</em></a>
<a class="reference internal" href="#protecting-page-access"><em>examples</em></a>.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">TailoredDocView</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span>
<span class="kn">from</span> <span class="nn">djangotailoring.tracking.views</span> <span class="kn">import</span> <span class="n">LogPageViewMixin</span>

<span class="k">class</span> <span class="nc">MyTailoredDocView</span><span class="p">(</span><span class="n">LogPageViewMixin</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">TailoredDocView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/mypage.html&#39;</span>
    <span class="n">message_document</span> <span class="o">=</span> <span class="s">&#39;Messages/MyTailoredDoc.messages&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The order of the above mixins matters. The page logging will happen before
the protection mechanism takes place. This way, the attempt to access the
and the subsequent redirect are logged. However, since the user is not
logged in, there is no sure way of linking the redirected <a class="reference internal" href="apps/djangotailoring.tracking/models.html#djangotailoring.tracking.models.Event" title="djangotailoring.tracking.models.Event"><tt class="xref py py-class docutils literal"><span class="pre">Event</span></tt></a>
with the user.</p>
</div>
</div>
</div>
<div class="section" id="survey-views">
<h2>Survey Views<a class="headerlink" href="#survey-views" title="Permalink to this headline">¶</a></h2>
<div class="section" id="a-basic-survey-view">
<span id="basic-survey-view"></span><h3>A Basic Survey View<a class="headerlink" href="#a-basic-survey-view" title="Permalink to this headline">¶</a></h3>
<p>Consider a situation where you have a Survey Document at
<tt class="docutils literal"><span class="pre">Surveys/Eligibility.survey</span></tt>, in your MTS project folder. You wish to save
the subject data on every page once the data is valid.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">djangotailoring.surveys.views</span> <span class="kn">import</span> <span class="n">SimpleSurveyView</span>
<span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">UserProfileMixin</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span>

<span class="k">class</span> <span class="nc">EligibilitySurveyView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserProfileMixin</span><span class="p">,</span> <span class="n">SimpleSurveyView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/eligsurvey.html&#39;</span>
    <span class="n">survey_document</span> <span class="o">=</span> <span class="s">&#39;Surveys/Eligibility.survey&#39;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s">&#39;Elig&#39;</span>
    <span class="n">survey_id</span> <span class="o">=</span> <span class="s">&#39;eligibility&#39;</span>

    <span class="k">def</span> <span class="nf">on_valid_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_subject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_subject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_end_of_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;home&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">templates/myapp/eligsurvey.html</span></tt>:</p>
<div class="highlight-python"><pre>{% extends "base.html" %}
{% load surveytags %}

{% block content %}
  &lt;form action="" method="post"&gt;
    {% render_survey_segment chunk %}
    &lt;div&gt;
      {% if previous_url %}
        &lt;a href="{{ previous_url }}"&gt;Previous&lt;/a&gt;
      {% endif %}
      &lt;button type="submit" name="submit" value="Next"&gt;
    &lt;/div&gt;
  &lt;/form&gt;
{% endblock %}</pre>
</div>
<p>In <tt class="docutils literal"><span class="pre">urls.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="n">EligibilitySurveyView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
  <span class="p">(</span><span class="s">r&#39;^eligibility/(?P&lt;page_id&gt;.*)$&#39;</span><span class="p">,</span> <span class="n">EligibilitySurveyView</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="protecting-a-survey">
<span id="id6"></span><h3>Protecting A Survey<a class="headerlink" href="#protecting-a-survey" title="Permalink to this headline">¶</a></h3>
<p>Sure, the survey in <a class="reference internal" href="#basic-survey-view"><em>the previous example</em></a> is already
protected from non-logged-in users, but what if the user should not be able to
return to the survey if they have already taken it?</p>
<p>We will make an event that should be recorded at the end of the survey, and
the presence of that event for the user will mean that they are no longer able
to take the survey.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">djangotailoring.surveys.views</span> <span class="kn">import</span> <span class="n">SimpleSurveyView</span>
<span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">UserProfileMixin</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span>
<span class="kn">from</span> <span class="nn">djangotailoring.tracking</span> <span class="kn">import</span> <span class="n">create_event</span>

<span class="n">COMPLETED_ELIGIBILITY_EVENTNAME</span> <span class="o">=</span> <span class="s">&#39;CompletedEligibilitySurvey&#39;</span>

<span class="k">class</span> <span class="nc">EligibilitySurveyView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserProfileMixin</span><span class="p">,</span> <span class="n">SimpleSurveyView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/eligsurvey.html&#39;</span>
    <span class="n">survey_document</span> <span class="o">=</span> <span class="s">&#39;Surveys/Eligibility.survey&#39;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s">&#39;Elig&#39;</span>
    <span class="n">survey_id</span> <span class="o">=</span> <span class="s">&#39;eligibility&#39;</span>

    <span class="k">def</span> <span class="nf">can_access_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">latest_event</span><span class="p">(</span><span class="n">COMPLETED_ELIGIBILITY_EVENTNAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span> <span class="ow">is</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">handle_bad_page_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_valid_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_subject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_subject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_end_of_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">create_event</span><span class="p">(</span><span class="n">COMPLETED_ELIGIBILITY_EVENTNAME</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;home&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="a-single-page-survey">
<span id="single-page-survey"></span><h3>A Single-Page Survey<a class="headerlink" href="#a-single-page-survey" title="Permalink to this headline">¶</a></h3>
<p>What if your survey called <tt class="docutils literal"><span class="pre">Single.survey</span></tt> that is so simple that it’s just
a single page of questions, and you would rather not deal with the ugly
numbers in the URL? Then use <tt class="xref py py-class docutils literal"><span class="pre">SinglePageSurveyView</span></tt>.</p>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">djangotailoring.surveys.views</span> <span class="kn">import</span> <span class="n">SinglePageSurveyView</span>
<span class="kn">from</span> <span class="nn">djangotailoring.views</span> <span class="kn">import</span> <span class="n">UserProfileMixin</span><span class="p">,</span> <span class="n">LoginRequiredMixin</span>

<span class="k">class</span> <span class="nc">MySingleSurveyView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserProfileMixin</span><span class="p">,</span> <span class="n">SinglePageSurveyView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/singlesurvey.html&#39;</span>
    <span class="n">survey_document</span> <span class="o">=</span> <span class="s">&#39;Surveys/Single.survey&#39;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">survey_id</span> <span class="o">=</span> <span class="s">&#39;single&#39;</span>

    <span class="k">def</span> <span class="nf">on_valid_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_subject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_subject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_end_of_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;home&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">urls.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="n">MySingleSurveyView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
  <span class="p">(</span><span class="s">r&#39;^single/$&#39;</span><span class="p">,</span> <span class="n">MySingleSurveyView</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="a-user-less-survey">
<span id="userless-survey"></span><h3>A User-less Survey<a class="headerlink" href="#a-user-less-survey" title="Permalink to this headline">¶</a></h3>
<p>Here&#8217;s a tricky one: What if you don’t want visitors to create a user account
before they take a survey?</p>
<p>The approach:</p>
<ul class="simple">
<li>Use the session to store a random user id.</li>
<li>Create a simple Mixin to handle the Subject access.</li>
<li>Create a subject in the default <a class="reference internal" href="apps/djangotailoring/subjects.html#djangotailoring.subjects.SubjectLoader" title="djangotailoring.subjects.SubjectLoader"><tt class="xref py py-class docutils literal"><span class="pre">SubjectLoader</span></tt></a> upon completion.</li>
</ul>
<p>In <tt class="docutils literal"><span class="pre">myapp/views.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">djangotailoring.project</span> <span class="kn">import</span> <span class="n">getsubjectloader</span>
<span class="kn">from</span> <span class="nn">djangotailoring.surveys.views</span> <span class="kn">import</span> <span class="n">SimpleSurveyView</span>

<span class="n">SUBJECT_ID_SESSION_KEY</span> <span class="o">=</span> <span class="s">&#39;subject_id&#39;</span>

<span class="k">class</span> <span class="nc">NoUserMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">subjectloader</span> <span class="o">=</span> <span class="n">getsubjectloader</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">session</span><span class="p">[</span><span class="n">SUBJECT_ID_SESSION_KEY</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">SUBJECT_ID_SESSION_KEY</span><span class="p">,</span> <span class="n">uuid4</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjectloader</span><span class="o">.</span><span class="n">empty_subject</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">save_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subjectloader</span><span class="o">.</span><span class="n">store_subject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(),</span> <span class="n">subject</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoLoginRequiredSurvey</span><span class="p">(</span><span class="n">NoUserMixin</span><span class="p">,</span> <span class="n">SimpleSurveyView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;myapp/nologinsurvey.html&#39;</span>
    <span class="n">survey_document</span> <span class="o">=</span> <span class="s">&#39;Surveys/NoLogin.survey&#39;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">survey_id</span> <span class="o">=</span> <span class="s">&#39;nologin&#39;</span>

    <span class="k">def</span> <span class="nf">handle_end_of_survey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_subject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_request_subject</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;register&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>After this, if part of the process is having a user create an account, you may
either copy data from the stored subject, or even consider modifying the
user_id attributes of the Subject and State storage mechanisms to the new
user id.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tailoring View Recipes</a><ul>
<li><a class="reference internal" href="#tailoring-views">Tailoring Views</a><ul>
<li><a class="reference internal" href="#a-basic-tailored-page">A Basic Tailored Page</a></li>
<li><a class="reference internal" href="#an-enhanced-tailored-page">An Enhanced Tailored Page</a></li>
<li><a class="reference internal" href="#multiple-documents-on-a-page">Multiple Documents on a Page</a></li>
<li><a class="reference internal" href="#tailored-page-titles">Tailored Page Titles</a></li>
<li><a class="reference internal" href="#logging-page-views">Logging Page Views</a></li>
<li><a class="reference internal" href="#protecting-page-access">Protecting Page Access</a></li>
<li><a class="reference internal" href="#logging-protected-page-access">Logging Protected Page Access</a></li>
</ul>
</li>
<li><a class="reference internal" href="#survey-views">Survey Views</a><ul>
<li><a class="reference internal" href="#a-basic-survey-view">A Basic Survey View</a></li>
<li><a class="reference internal" href="#protecting-a-survey">Protecting A Survey</a></li>
<li><a class="reference internal" href="#a-single-page-survey">A Single-Page Survey</a></li>
<li><a class="reference internal" href="#a-user-less-survey">A User-less Survey</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="apps/djangotailoring.tracking/views.html"
                        title="previous chapter"><tt class="docutils literal"><span class="pre">djangotailoring.tracking.views</span></tt></a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/recipes.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="apps/djangotailoring.tracking/views.html" title="djangotailoring.tracking.views"
             >previous</a> |</li>
        <li><a href="index.html">djangotailoring v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Dennis O’Reilly.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>